# この例示について
この例示は、[AI Shell](https://github.com/PowerShell/AIShell)と**SingleMCController**を使用して対話的にサーボ軸の基本的な位置決め操作をします。
使い勝手は、AI Shellで使用するチャットAIのモデル、プロンプト次第です。
操作指示をドメイン固有の用語を含む自然言語で与え、適切にSingleMCControllerを使用する操作コードを生成するようにコンテクストを構成させた後、プロンプトで操作指示を与えます。
UAMotionLinkは、OPC UAサーバを介してモーションFBを操作するインターフェースを提供するに留まります。
そのため、任意のOPC UAクライアントでSingleMCController同様の操作を実装することで、同等の操作を行うことができます。
これにより、Pythonで使用可能なOPC UAクライアントとJupyterLabという構成も可能です。

AI Shellを介して以下のようにサーボを操作できます。

![AI Shellを介したサーボ操作](../../images/control-with-ai-shell.gif)

## 目的
UAMotionLinkLibは、試運転や調整でその場限りのサーボ操作が必要であるとき、IDE操作の手間や、操作のためのインプレースでの変更を無くすことにあります。
SingleMCControllerは、UAMotionLinkLibが提供するサーボ操作インターフェースへのクライアント機能を提供しますが、PowerShellによる操作スクリプトが必要です。
PowerShellの操作に慣れていなければ、スクリプト作成に時間がかかるかもしれません。
慣れていたとしても手間であることに変わりありません。
そのため、単にSingleMCControllerを使用するだけでは、UAMotionLinkLib使用の意図に十分に応えることができません。
そこで、AI ShellのようなCLI形式のチャットインターフェースを使用し、自然言語で指示を出して動的にコードを生成、実行します。
これにより、操作の効率性と柔軟性が大きく向上し、UMAMotionLinkLib使用の効果を大幅に向上することができます。

SingleMCControllerの使用は、リモートからのアクチュエータ操作なので、リスクがある事に変わりありません。
まして、生成AIが生成したコードを実行して操作するのですから、尚更リスクがあると考えるかもしれません。
しかし、そのリスクは、生成AIの不確かさが直接に反映されるものではありません。
開発者が適切な振る舞い実装することでコントロールできるものです。
外部からの動作指令は、物理的なスイッチか否か、ヒトか否かによらず同等に検査する必要があります。
不備があれば拒絶します。
また、どのような操作を可能にするかは開発者がコントロールします。

UAMotionLinkLibのサーボ操作インターフェースの持つリスクが許容できないものであれば、許容できる水準に改修することも可能です。
あるいは、よりリスクを許容して既存のインターフェースを参考にサーボレディや継続動作を可能とする機能を追加することもできます。
全ては開発者次第です。

## 構成
Sysmacプロジェクトと.env以外はチャットAIへの指示で使用しているだけなので、必須というわけではありません。
チャットAIが適切にコードを生成してAI Shellが実行できるようになるのであれば、どのような構成でも問題ありません。

* **ExampleControlWithAIShell.smc2**   
  この例示で使用するSysmacプロジェクトです。

* **context.md**   
  作業について全般的な事項を記したドキュメントです。

* **machine.md**   
  操作対象とする装置と軸について記したドキュメントです。
  チャットAIにドメイン固有の情報を提供するために使用します。

* **.env.template**   
  .envファイルのテンプレートです。
  OPC UAサーバのエンドポイント、SingleMCControllerの設定を環境変数として渡すために使用します。

## 使い方
このディレクトリをカレントディレクトリとしてAI Shellを使用します。
モデルは、`gemini-2.5-flash`を使用します。
対象がチャットAIなので再現性を保証することはできませんが、最終的に意図する状態に到達させることは難しくありません。
生成されたスクリプトに不備があることは十分にあり得ます。
実機で試す場合、停止、非常停止が可能な状態で試してください。

1. **AI Shellのセットアップ**   
   [AI シェルをインストールする](https://learn.microsoft.com/ja-jp/powershell/utility-modules/aishell/install-aishell?view=ps-modules)を参照してください。

2. **SingleMCControllerのセットアップ**   
   PwshOpcUaClientをセットアップします。
   [PwshOpcUaClient]を参照してください。
   コントローラを対象とする場合、コントローラのOPC UAサーバでPwshOpcUaClientのクライアント証明書の許可が必要です。

3. **シミュレータを起動**   
   SysmacプロジェクトをSysmac Studio開き、シミュレータとOPC UAサーバを起動、設定します。
   OPC UAサーバの設定はメーカーのマニュアルを参照してください。
   `.env.template`の内容に合わせてOPC UAサーバを構成します。

4. **.envの用意**   
   `.env.template`を`.env`に改名します。

5. **AI Shellを起動**   
   Windowsターミナルを起動し、このディレクトリをカレントディレクトリとしてAI Shellを起動します。

6. **チャットAIにコンテクストを認識させる**   
   冒頭の画像のように対話的にチャットAIにコンテクストを認識させ、以後のサーボ操作をスムーズに実行できるようにします。
   必要であれば、システムプロンプトも変更してください。

7. **サーボ操作**   
   プロンプトで指示を出しつつサーボを操作します。
